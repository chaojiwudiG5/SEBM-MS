name: Build, Dockerize and Push to ACR

on:
    push:
        branches:
            - main
    workflow_dispatch:

jobs:
    build-and-docker:
        runs-on: ubuntu-latest

        env:
            ACR_REGISTRY: crpi-vqzgcvtc07egicyr.ap-southeast-1.personal.cr.aliyuncs.com# 例如 registry.cn-shanghai.aliyuncs.com/your-namespace
            ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
            ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}

        steps:
            # === 1️⃣ 检出代码 ===
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            # === 2️⃣ 设置 JDK 环境 ===
            - name: Set up JDK 17
              uses: actions/setup-java@v4
              with:
                  distribution: 'temurin'
                  java-version: '17'
                  cache: maven

            # === 3️⃣ 一键打包所有模块 ===
            - name: Build all modules
              run: mvn -B clean package -DskipTests

            # === 4️⃣ 登录阿里云 ACR ===
            - name: Login to Alibaba Cloud ACR
              uses: docker/login-action@v2
              with:
                  username: ${{ env.ACR_USERNAME }}
                  password: ${{ env.ACR_PASSWORD }}
                  registry: ${{ env.ACR_REGISTRY }}

            # === 5️⃣ 构建并推送 Docker 镜像 ===
            - name: Build and Push Docker images
              run: |
                set -e  # 任何命令失败就停止
                modules="sebm-borrow-service sebm-user-service sebm-device-service sebm-gateway sebm-maintenance-service"
                for module in $modules; do
                  echo "=== Building Docker image for $module ==="
                  docker build -t $ACR_REGISTRY/$module:latest "./$module"
                  echo "=== Pushing Docker image for $module ==="
                  docker push $ACR_REGISTRY/$module:latest
                done


